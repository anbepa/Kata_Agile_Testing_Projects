name: CI/CD Pipeline - Agile Testing Kata (E2E UI Only)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  # ==================================================================
  # FASE 1: CI (Build) - Compilaci贸n y Preparaci贸n del C贸digo
  # ==================================================================
  CI_Build_Project:
    name: Build All Projects
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # Reemplazo de tokens en archivos de configuraci贸n
      - name: Replace Tokens
        uses: cschleiden/replace-tokens@v1
        with:
          tokenPrefix: '__'
          tokenSuffix: '__'
          files: '["E2E/**/*.conf", "E2E/**/*.properties", "E2E/**/pom.xml"]'
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
          USER_ADMIN: ${{ secrets.USER_ADMIN }}
          USER_PASS: ${{ secrets.USER_PASS }}
          BROWSERSTACK_USER: ${{ secrets.BROWSERSTACK_USER }}
          BROWSERSTACK_KEY: ${{ secrets.BROWSERSTACK_KEY }}

      # Compilaci贸n E2E
      - name: Maven Build E2E (Skip Tests)
        run: |
          cd E2E
          mvn clean package -DskipTests

      # Compilaci贸n Apis
      - name: Maven Build Apis (Skip Tests)
        run: |
          cd Apis
          mvn clean package -DskipTests

      # Guardamos el artefacto E2E
      - name: Upload Build Artifact E2E
        uses: actions/upload-artifact@v4
        with:
          name: e2e-build-artifact
          path: E2E/
          retention-days: 1

      # Guardamos el artefacto Apis
      - name: Upload Build Artifact Apis
        uses: actions/upload-artifact@v4
        with:
          name: apis-build-artifact
          path: Apis/
          retention-days: 1

  # ==================================================================
  # FASE 2: CD (Test & Report) - Ejecuci贸n y Entrega de Resultados
  # ==================================================================
  CD_Execute_E2E:
    name: Execute UI Tests & Report
    needs: CI_Build_Project # Dependencia estricta: No corre si el Build falla
    runs-on: ubuntu-latest
    if: always() # Intenta correr aunque el CI tenga advertencias, pero 'needs' manda
    permissions:
      contents: write # Necesario para publicar en GitHub Pages
    
    steps:
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # Descargamos el c贸digo ya preparado en la fase anterior
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: e2e-build-artifact
          path: E2E

      # Ejecuci贸n de Tests y Generaci贸n del Reporte
      - name: Run E2E Tests and Generate Report
        env:
          BROWSERSTACK_USER: ${{ secrets.BROWSERSTACK_USER }}
          BROWSERSTACK_KEY: ${{ secrets.BROWSERSTACK_KEY }}
        run: |
          cd E2E
          mvn clean verify serenity:aggregate || true

      # Almacenamiento del Reporte como Artefacto
      - name: Upload Serenity Report
        uses: actions/upload-artifact@v4
        with:
          name: e2e-report
          path: E2E/target/site/serenity
          if-no-files-found: warn



  # ==================================================================
  # FASE 4: CD (Test & Report) - Apis
  # ==================================================================
  CD_Execute_Apis:
    name: Execute API Tests & Report
    needs: CI_Build_Project
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write
      
    steps:
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: apis-build-artifact
          path: Apis

      - name: Run API Tests and Generate Report
        run: |
          cd Apis
          mvn clean test || true

      - name: Upload Karate Report
        uses: actions/upload-artifact@v4
        with:
          name: api-report
          path: Apis/target/karate-reports
          if-no-files-found: warn

  # ==================================================================
  # FASE 5: Performance Tests (JMeter)
  # ==================================================================
  Performance_Test:
    name: Execute Performance Tests
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install JMeter
        run: |
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xvzf apache-jmeter-5.6.3.tgz
          rm apache-jmeter-5.6.3.tgz
          mv apache-jmeter-5.6.3 jmeter

      - name: Run JMeter Performance Test
        run: |
          ./jmeter/bin/jmeter -n -t Performance/login_load_test.jmx \
            -l result.jtl -e -o performance-report \
            -JUsrAuthorization=${{ vars.JMETER_USERS || 2 }} \
            -JRampAuthorization=${{ vars.JMETER_RAMPUP || 1 }} \
            -JDurationAuthorization=${{ vars.JMETER_DURATION || 10 }}

      - name: Generate JMeter Summary Metrics
        run: |
          awk -F',' '
            BEGIN { total=0; fail=0; time=0; }
            NR>1 {
              total++;
              time+=$2;
              if ($8 == "false") fail++;
            }
            END {
              if (total > 0) {
                print "### 憋 Performance Quick Look";
                print "| Metric | Value |";
                print "|--------|-------|";
                print "| **Total Requests** | " total " |";
                printf "| **Avg Response Time** | %.2f ms |\n", time/total;
                printf "| **Error Rate** | %.2f%% |\n", (fail/total)*100;
              } else {
                print "### 锔 No Performance Data Recorded";
              }
            }
          ' result.jtl > performance_summary.md

      - name: Upload Performance Summary
        uses: actions/upload-artifact@v4
        with:
          name: performance-summary
          path: performance_summary.md

      - name: Upload Performance Report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance-report
          if-no-files-found: warn

  # ==================================================================
  # FASE 6: Publicaci贸n Unificada de Reportes
  # ==================================================================
  Deploy_Reports:
    name: Deploy Combined Reports
    needs: [CD_Execute_E2E, CD_Execute_Apis, Performance_Test]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write
      
    steps:
      - name: Download E2E Report
        uses: actions/download-artifact@v4
        with:
          name: e2e-report
          path: public

      - name: Download API Report
        uses: actions/download-artifact@v4
        with:
          name: api-report
          path: public/karate-reports

      - name: Download Performance Report
        uses: actions/download-artifact@v4
        with:
          name: performance-report
          path: public/performance-report

      - name: Download Performance Summary
        uses: actions/download-artifact@v4
        with:
          name: performance-summary
          path: .

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          keep_files: false
          force_orphan: true

      - name: Generate Report Summary
        run: |
          echo "###  Test Reports Ready!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Report Type | Link |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|------|" >> $GITHUB_STEP_SUMMARY
          echo "|  **E2E (Serenity)** | [View Report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/index.html) |" >> $GITHUB_STEP_SUMMARY
          echo "|  **API (Karate)** | [View Report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/karate-reports/karate-summary.html) |" >> $GITHUB_STEP_SUMMARY
          echo "|  **Performance (JMeter)** | [View Report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/performance-report/index.html) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f performance_summary.md ]; then
            cat performance_summary.md >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> 锔 **Note:** It may take a minute for GitHub Pages to update after the workflow completes." >> $GITHUB_STEP_SUMMARY
