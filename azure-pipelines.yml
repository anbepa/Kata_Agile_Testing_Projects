trigger:
  - main

pr:
  - main

variables:
  # Variables por defecto (puedes sobreescribirlas en el Pipeline o Variable Groups)
  ORANGEHRM_URL: 'https://opensource-demo.orangehrmlive.com'
  ORANGEHRM_USERNAME: 'Admin'
  ORANGEHRM_PASSWORD: 'admin123'

  API_DIR: 'Apis'
  E2E_DIR: 'E2E'
  PERF_DIR: 'Performance'

stages:

  # =============================================================
  # STAGE 1 - Prueba de API
  # =============================================================
  - stage: PruebaDeApi
    displayName: 'Prueba de api'
    jobs:
      - job: ApiJob
        displayName: 'Ejecución pruebas API'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          # 1) Replace Tokens
          # Requiere extensión "Replace Tokens" (qetza).
          - task: replacetokens@5
            displayName: 'Replace Tokens'
            inputs:
              rootDirectory: '$(System.DefaultWorkingDirectory)/$(API_DIR)'
              targetFiles: |
                **/karate-config.js
                **/*.feature
              encoding: 'auto'
              tokenPattern: 'default'
              writeBOM: true
              actionOnMissing: 'warn'
              keepToken: false

          # 2) Compilar y ejecutar tests con Maven
          - task: Maven@3
            displayName: 'Compile & Test (Maven)'
            inputs:
              mavenPomFile: '$(System.DefaultWorkingDirectory)/$(API_DIR)/pom.xml'
              goals: 'clean test'
              options: >
                -DbaseUrl=$(ORANGEHRM_URL)
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '17'
              mavenVersionOption: 'Default'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'

          # 3) Publish Cucumber Report
          # Requiere extensión de Cucumber report.
          # Si usas Serenity para APIs con Cucumber, ajusta la ruta del json.
          - task: PublishCucumberReport@1
            displayName: 'Publish Cucumber Report'
            inputs:
              jsonDir: '$(System.DefaultWorkingDirectory)/$(API_DIR)/target'
              outputPath: '$(System.DefaultWorkingDirectory)/$(API_DIR)/target/cucumber-report'
              theme: 'bootstrap'
              reportSuiteAsScenarios: true
              name: 'API Cucumber Report'

  # =============================================================
  # STAGE 2 - E2E
  # =============================================================
  - stage: E2E
    displayName: 'E2E'
    dependsOn: PruebaDeApi
    condition: succeeded()
    jobs:
      - job: E2EJob
        displayName: 'Ejecución pruebas E2E'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          # 1) Replace Tokens
          - task: replacetokens@5
            displayName: 'Replace Tokens'
            inputs:
              rootDirectory: '$(System.DefaultWorkingDirectory)/$(E2E_DIR)'
              targetFiles: |
                **/serenity.conf
                **/*.feature
              encoding: 'auto'
              tokenPattern: 'default'
              writeBOM: true
              actionOnMissing: 'warn'
              keepToken: false

          # 2) Compilar y ejecutar tests con Maven
          - task: Maven@3
            displayName: 'Compile & Test (Maven)'
            inputs:
              mavenPomFile: '$(System.DefaultWorkingDirectory)/$(E2E_DIR)/pom.xml'
              goals: 'clean test'
              options: >
                -Dweb.base.url=$(ORANGEHRM_URL)/web/index.php
                -Dorangehrm.username=$(ORANGEHRM_USERNAME)
                -Dorangehrm.password=$(ORANGEHRM_PASSWORD)
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '17'
              mavenVersionOption: 'Default'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'

          # 3) Serenity Report Upload
          # Requiere extensión de Serenity report para Azure DevOps.
          - task: SerenityReportPublish@1
            displayName: 'Serenity Report Upload'
            inputs:
              testResultsDir: '$(System.DefaultWorkingDirectory)/$(E2E_DIR)/target/site/serenity'
              reportName: 'E2E Serenity Report'

  # =============================================================
  # STAGE 3 - Performance
  # =============================================================
  - stage: Performance
    displayName: 'performance'
    dependsOn: E2E
    condition: succeeded()
    jobs:
      - job: PerfJob
        displayName: 'Ejecución pruebas Performance'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          # JMeter Test
          # Usa el jmeter-maven-plugin configurado en el pom del proyecto Performance.
          - task: Maven@3
            displayName: 'JMeter Test'
            inputs:
              mavenPomFile: '$(System.DefaultWorkingDirectory)/$(PERF_DIR)/pom.xml'
              goals: 'clean verify'
              options: >
                -Dorangehrm.url=$(ORANGEHRM_URL)
                -DjmeterThreads=50
                -DjmeterRampUp=30
                -DjmeterDuration=300
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '17'
              mavenVersionOption: 'Default'

          # Publish HTML Report
          # Si el plugin genera el reporte en una ruta distinta, ajusta aquí.
          - task: PublishHtmlReport@1
            displayName: 'Publish HTML Report'
            inputs:
              reportDir: '$(System.DefaultWorkingDirectory)/$(PERF_DIR)/target/jmeter/results'
              tabName: 'Performance Report'
              reportTitle: 'JMeter Performance Report'

